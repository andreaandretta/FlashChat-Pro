# FlashChat Pro - Android Build Pipeline
# Build APK usando GitHub Actions (bypassa EAS Cloud)
# 
# PREREQUISITI: Configura questi GitHub Secrets:
# - ANDROID_KEYSTORE_BASE64: Keystore in base64
# - KEYSTORE_PASSWORD: Password del keystore
# - KEY_ALIAS: Alias della chiave (es: flashchat)
# - KEY_PASSWORD: Password della chiave

name: ðŸš€ Build Android APK

on:
  # Trigger manuale
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Profilo di build (preview/production)'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
  
  # Trigger automatico su push al main
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build-android:
    name: ðŸ“¦ Build APK
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # 1. SETUP INIZIALE
      # ============================================
      
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ” Check required secrets
        run: |
          echo "Checking if required secrets are configured..."
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "âŒ ERROR: ANDROID_KEYSTORE_BASE64 secret is not set!"
            echo "Please go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "And create the required secrets."
            exit 1
          fi
          if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
            echo "âŒ ERROR: KEYSTORE_PASSWORD secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            echo "âŒ ERROR: KEY_ALIAS secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "âŒ ERROR: KEY_PASSWORD secret is not set!"
            exit 1
          fi
          echo "âœ… All required secrets are configured!"
      
      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
      
      # ============================================
      # 2. KEYSTORE
      # ============================================
      
      - name: ðŸ” Decode Keystore
        run: |
          mkdir -p android
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/release-key.jks
          if [ -f android/release-key.jks ]; then
            echo "âœ… Keystore decoded successfully"
            ls -la android/release-key.jks
          else
            echo "âŒ Failed to decode keystore"
            exit 1
          fi
      
      - name: ðŸ“ Create credentials.json for EAS
        run: |
          cat > credentials.json << 'CREDENTIALS_EOF'
          {
            "android": {
              "keystore": {
                "keystorePath": "android/release-key.jks",
                "keystorePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.KEY_ALIAS }}",
                "keyPassword": "${{ secrets.KEY_PASSWORD }}"
              }
            }
          }
          CREDENTIALS_EOF
          echo "âœ… credentials.json created"
      
      # ============================================
      # 3. DEPENDENCIES
      # ============================================
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci || npm install
      
      - name: ðŸ”§ Install EAS CLI globally
        run: npm install -g eas-cli
      
      # ============================================
      # 4. BUILD
      # ============================================
      
      - name: ðŸ—ï¸ Run EAS Build (Local)
        run: |
          PROFILE="${{ github.event.inputs.build_profile || 'preview' }}"
          echo "Building with profile: $PROFILE"
          
          npx eas build \
            --platform android \
            --profile $PROFILE \
            --local \
            --non-interactive \
            --output ./flashchat-pro.apk
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_LOCAL_BUILD_SKIP_CLEANUP: 1
      
      # ============================================
      # 5. UPLOAD ARTIFACT
      # ============================================
      
      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlashChat-Pro-${{ github.event.inputs.build_profile || 'preview' }}-${{ github.sha }}
          path: ./flashchat-pro.apk
          retention-days: 30
          if-no-files-found: error
      
      # ============================================
      # 6. CLEANUP
      # ============================================
      
      - name: ðŸ§¹ Cleanup sensitive files
        if: always()
        run: |
          rm -f android/release-key.jks 2>/dev/null || true
          rm -f credentials.json 2>/dev/null || true
          echo "âœ… Sensitive files cleaned up"
      
      # ============================================
      # 7. SUMMARY
      # ============================================
      
      - name: ðŸ“‹ Build Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Build Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** ${{ github.event.inputs.build_profile || 'preview' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the APK from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
