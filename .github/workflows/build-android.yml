# FlashChat Pro - Android Build Pipeline
# Build APK usando GitHub Actions (BYPASS COMPLETO EAS CLOUD)
# 
# PREREQUISITI: Configura questi GitHub Secrets:
# - ANDROID_KEYSTORE_BASE64: Keystore in base64 (NO newline!)
# - KEYSTORE_PASSWORD: Password del keystore
# - KEY_ALIAS: Alias della chiave
# - KEY_PASSWORD: Password della chiave

name: ðŸš€ Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Tipo di build'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
  
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  check-secrets:
    name: ðŸ” Check Secrets
    runs-on: ubuntu-latest
    outputs:
      has_secrets: ${{ steps.check.outputs.has_secrets }}
    steps:
      - name: Check required secrets
        id: check
        run: |
          echo "ðŸ” Checking GitHub Secrets..."
          
          MISSING=()
          
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            MISSING+=("ANDROID_KEYSTORE_BASE64")
          fi
          
          if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
            MISSING+=("KEYSTORE_PASSWORD")
          fi
          
          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            MISSING+=("KEY_ALIAS")
          fi
          
          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            MISSING+=("KEY_PASSWORD")
          fi
          
          if [ ${#MISSING[@]} -ne 0 ]; then
            echo "âŒ MISSING SECRETS:"
            for secret in "${MISSING[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "ðŸ‘‰ Come configurare:"
            echo "   1. Vai su: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   2. Clicca 'New repository secret'"
            echo "   3. Aggiungi ognuno dei secrets mancanti"
            echo ""
            echo "ðŸ“‹ Per generare il keystore in locale:"
            echo "   keytool -genkey -v -keystore flashchat.keystore -alias flashchat -keyalg RSA -keysize 2048 -validity 10000"
            echo "   base64 -w 0 flashchat.keystore"
            echo ""
            echo "â— IMPORTANTE: Il base64 deve essere generato con 'base64 -w 0' (no newline)"
            echo ""
            echo "::error::Missing required secrets: ${MISSING[*]}"
            exit 1
          fi
          
          echo "âœ… All secrets are configured!"
          echo "has_secrets=true" >> $GITHUB_OUTPUT

  build-android:
    name: ðŸ“¦ Build APK
    needs: check-secrets
    runs-on: ubuntu-latest
    if: needs.check-secrets.outputs.has_secrets == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          npm install -g expo-cli
      
      - name: ðŸ—ï¸ Expo Prebuild
        run: |
          npx expo prebuild --platform android --clean
          echo "âœ… Android project generated"
      
      - name: ðŸ” Decode Keystore
        run: |
          mkdir -p android/app
          
          # Decodifica base64 con gestione errori
          if ! echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore 2>/dev/null; then
            echo "âŒ ERROR: Invalid base64 in ANDROID_KEYSTORE_BASE64 secret!"
            echo ""
            echo "Possible causes:"
            echo "   1. Secret not set"
            echo "   2. Base64 was copied with newlines or spaces"
            echo "   3. Corrupted keystore file"
            echo ""
            echo "To fix:"
            echo "   base64 -w 0 your-keystore.jks"
            echo "   Copy the ENTIRE output as the secret value"
            exit 1
          fi
          
          # Verifica che il file esista e non sia vuoto
          if [ ! -s android/app/release.keystore ]; then
            echo "âŒ ERROR: Decoded keystore is empty!"
            exit 1
          fi
          
          echo "âœ… Keystore decoded successfully"
          ls -lh android/app/release.keystore
      
      - name: ðŸ“ Configure Signing
        run: |
          # Configura gradle.properties
          cat >> android/gradle.properties << EOF

# Signing Config
MYAPP_UPLOAD_STORE_FILE=release.keystore
MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
EOF
          
          # Patch build.gradle per usare il signing
          cat >> android/app/build.gradle << 'EOF'

// CI Signing Config
android {
    signingConfigs {
        release {
            storeFile file(MYAPP_UPLOAD_STORE_FILE)
            storePassword MYAPP_UPLOAD_STORE_PASSWORD
            keyAlias MYAPP_UPLOAD_KEY_ALIAS
            keyPassword MYAPP_UPLOAD_KEY_PASSWORD
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
EOF
          echo "âœ… Signing configured"
      
      - name: âš¡ Build APK
        run: |
          cd android
          chmod +x ./gradlew
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          BUILD_TYPE_CAP=$(echo "$BUILD_TYPE" | sed 's/.*/\u&/')
          
          echo "Building: assemble${BUILD_TYPE_CAP}"
          ./gradlew "assemble${BUILD_TYPE_CAP}" --no-daemon --console=plain
      
      - name: ðŸ“‹ Find and Rename APK
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          BUILD_TYPE_LOWER=$(echo "$BUILD_TYPE" | tr '[:upper:]' '[:lower:]')
          
          # Trova l'APK
          APK_PATH=$(find android -name "*.apk" -type f | grep -E "(${BUILD_TYPE_LOWER}|universal)" | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            echo "Searching all APKs..."
            find android -name "*.apk" -type f
            exit 1
          fi
          
          echo "âœ… Found APK: $APK_PATH"
          cp "$APK_PATH" "./FlashChat-Pro-${BUILD_TYPE}.apk"
          ls -lh "./FlashChat-Pro-${BUILD_TYPE}.apk"
      
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: FlashChat-Pro-${{ github.event.inputs.build_type || 'release' }}-${{ github.run_number }}
          path: ./*.apk
          retention-days: 30
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f android/app/release.keystore ./*.apk 2>/dev/null || true
      
      - name: ðŸ“‹ Summary
        if: success()
        run: |
          echo "## âœ… Build Completato!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Scarica l'APK dagli **Artifacts** â˜ï¸" >> $GITHUB_STEP_SUMMARY
